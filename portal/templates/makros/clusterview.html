{% import 'makros/utils.html' as utils %}

{% macro table_hosts() -%}
  <table id="hosts" class="table table-striped table-bordered cell-border compact hover">
	  <thead>
<tr>	
<th>Host</th>
<th>Available Versions</th>
<th>State</th>
<th>Actions</th>
</tr>
	</thead>

<tbody id="hostlist">


</tbody>
  </table>
 {%- endmacro %}

 {% macro table_clusters() -%}
  <table id="clusters" class="table table-striped table-bordered cell-border compact hover">
	  <thead>
<tr>	
<th>Name</th>
<th>Version</th>
<th>Host</th>
<th>Port</th>
<th>State</th>
<th>Actions</th>
</tr>
	</thead>

<tbody id="clusterlist">


</tbody>
  </table>
{%- endmacro %}


{% macro js_clusterview(hostlist) -%}
<script>
var $table_clusters;
var $table_hosts;


function addClusterModal ( modal_identifier, host ){
        var modal =`
<div id="`+modal_identifier+`" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">CreateCluster</h4>
      </div>
      <div class="modal-body">
      <form>
	<label >ClusterName:</label>
	    <input type="text" id="clustername" class="form-control formignore" >
			</div>
      <div class="btn-group btn-group-justified versionlist">
		</div>
<div class="form-group">

<!--<label class="checkbox-inline"><input type="checkbox" value="data-checksums" checked disabled>Enable Heap-Checksums</label>
</div> Checksums are always enabled-->
<div class="form-group">
<br>	
  <div class="input-group">
    <span class="input-group-addon">Port</span>
    <input type="text" class="form-control" name="port" placeholder="auto">
  </div>
  <!--
  <div class="input-group">
    <span class="input-group-addon">Datadir</span>
    <input type="text" class="form-control" name="datadir" placeholder="auto">
  </div>
  <div class="input-group">
    <span class="input-group-addon">WAL-Dir</span>
    <input type="text" class="form-control" name="waldir" placeholder="auto">
  </div>	

	
  -->
	
	
	</form>	
      <div class="modal-footer">
        <button type="button" class="btn btn-default"  onclick="
	var version	=	$(this).closest('.modal-dialog').find('.active').attr('data-button');
	var cluster 	=	$(this).closest('.modal-dialog').find('#clustername').val() ;
	if ( cluster == undefined || cluster == ''){ alert ('A name is required.');}
	else if ( version == undefined){ alert ('A version is required'); }
	else{
       	pg_ctl(
					{ x: this,
					 host: '`+host+`',
					version: version,
					cluster: cluster,
					action: 'create', 
						       data: inputvalues_to_dict( $(this).closest('.modal-dialog') ) , 
					call_success: function(){
						refresh(); 
						$(this).closest('.modal').modal('hide');
						$('body').removeClass('modal-open');
						$('.modal-backdrop').remove();
						}}); 

	}
					;">Create</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Dismiss</button>
      </div>
    </div>

  </div>`;

	return modal;}

function pushClusterInfo ( result, _url ){
	var modal_identifier = 'createcluster'+ Math.floor( Math.random()*100000 );
	var modal = addClusterModal ( modal_identifier, _url ) ;
	var rawRow = $table_hosts.row.add( [ _url,
		'<div class="available_versions"></div>',
		'<span class="label label-success">connected</span>', 
		'<button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#'+modal_identifier+'">Add Instance</button>'+modal] )
			.draw(true).node() ;
	pg_ctl({host: _url, action: 'ls-system',
		call_success: function(data){
			$.each( $(data)[0]['installed_pg_versions'],
				function( version ){  $(rawRow).find('.available_versions').append('<span class="label label-success">'+version+'</span> ');
				$('#'+modal_identifier).find('.versionlist').append( `
					<div class="btn-group btn-group-justified">
					<button type="button" class="btn btn-primary versionselector" onclick="$('.versionselector').removeClass('active'); $(this).addClass('active'); " data-button="`+version+`">`+version+`</button>
					</div>`) ;
				})
			}});
	for ( var i = 0; i < result.length ; i++ ){
		var state = 'Unknown';
		if (result[i]['running']=='1'){state='<span class="label label-success">ONLINE</span>';}
		else if ( result[i]['running']=='0')  {state='<span class="label label-danger">OFFLINE</span>';}
		if (result[i]['recovery']=='1'){state+='<span class="label label-info">IN RECOVERY</span>';}
		var dbelement = $table_clusters.row.add([
			result[i]['cluster'],
			result[i]['version'],
			_url,
			result[i]['port'],
			state,
			'<a href="{{ url_for("index") }}detail/'+_url+'/'+result[i]['version']+'/'+result[i]['cluster']+'"><button type="button" class="btn btn-default btn-sm">Details</button></a>'+
			'<a href="https://localhost/grafana/d/5CGjHlRiz/postgresql-server-overview?refresh=1m&orgId=1">' 
			]).node() ;// .draw(true).node() ;
	}
	$table_clusters.draw(true);
	querybar_add_success();
}

function refresh(repeat){
	querybar_reset_and_init();

	$table_clusters.clear();
	$table_hosts.clear();
	//$table_clusters.draw();

	querybar_set_numelements( {{ hostlist.__len__() }} );

	function pullClusterInfo( _url ){
		pg_ctl({ host: _url, action: 'ls',
			call_success : function(result){pushClusterInfo(result,_url) },
			call_fail: function(request, status, err){
				        console.log(request);
					console.log(err);
					querybar_add_fail();
					push_notification( 'Connection to '+_url+' failed.');
					var rawRow = $table_hosts.row.add( [_url,
						  '',
						  '<span class="label label-danger">unreachable</span>',
						  ''
						] ).draw(true).node() ;
			}}
			);
		};
	{% for host in hostlist %}
	setTimeout(function(){ 
			pullClusterInfo( '{{ host['address'] }}' )
			}, 1);
	{% endfor %}
	if ( repeat ) {	setTimeout(function(){refresh(true)}, 5*60*1000); }
}

$(document).ready(function() {
	$table_clusters = $('#clusters').DataTable({"order":[[0, "asc"] ], "paging": false }); 
	$table_hosts = $('#hosts').DataTable({"order":[[0, "asc"]], "paging": false });

refresh(true);
});

</script>
{{ utils.clusterctl_js() }}

{%- endmacro %}
